# حل مشکل ثبت آگهی

## مشکل
خطای زیر هنگام ثبت آگهی رخ می‌دهد:
```
POST http://localhost:8080/api/ads/create net::ERR_ABORTED 404 (Not Found)
```

## علت مشکل
PostAdPage سعی می‌کند به API endpoint محلی `http://localhost:8080/api/ads/create` درخواست بفرستد، اما این endpoint وجود ندارد.

## راه حل پیاده‌سازی شده

### 1. تغییر از API محلی به Supabase
- حذف درخواست به `/api/ads/create`
- استفاده مستقیم از Supabase client
- اضافه کردن مدیریت خطا و loading state

### 2. بهبودهای اضافه شده
- ✅ استفاده از Supabase برای ثبت آگهی
- ✅ مدیریت خطا با toast notifications
- ✅ Loading state برای دکمه ثبت
- ✅ CategorySelector دینامیک از دیتابیس
- ✅ اعتبارسنجی فرم بهبود یافته
- ✅ آپلود تصاویر به Supabase Storage

### 3. فایل‌های تغییر یافته
- **`src/pages/PostAdPage.tsx`** - اصلاح شده برای استفاده از Supabase
- **`src/components/post-ad/CategorySelector.tsx`** - کامپوننت جدید برای انتخاب دسته‌بندی

## نحوه کارکرد جدید

### ثبت آگهی:
1. کاربر فرم را پر می‌کند
2. تصاویر به Supabase Storage آپلود می‌شوند
3. آگهی مستقیماً در جدول `ads` ثبت می‌شود
4. وضعیت آگهی به `pending` تنظیم می‌شود
5. پیام موفقیت نمایش داده می‌شود

### دسته‌بندی‌ها:
- دسته‌بندی‌ها از دیتابیس خوانده می‌شوند
- CategorySelector کامپوننت دینامیک است
- خطاهای بارگذاری مدیریت می‌شوند

## تست عملکرد

### 1. تست ثبت آگهی:
```bash
# اجرای پروژه
npm run dev

# رفتن به صفحه ثبت آگهی
# پر کردن فرم و تست ثبت
```

### 2. بررسی در دیتابیس:
```sql
-- بررسی آگهی‌های ثبت شده
SELECT * FROM ads WHERE status = 'pending' ORDER BY created_at DESC;
```

## نکات مهم

### امنیت:
- آگهی‌های جدید با وضعیت `pending` ثبت می‌شوند
- فقط ادمین‌ها می‌توانند آگهی‌ها را تایید کنند
- کاربران فقط آگهی‌های خود را می‌بینند

### عملکرد:
- آپلود تصاویر به صورت async انجام می‌شود
- Loading state برای جلوگیری از ثبت تکراری
- مدیریت خطا با toast notifications

### دسته‌بندی‌ها:
- دسته‌بندی‌ها از دیتابیس خوانده می‌شوند
- اگر دسته‌بندی وجود نداشته باشد، خطا نمایش داده می‌شود
- CategorySelector کامپوننت قابل استفاده مجدد است

## عیب‌یابی

### اگر خطای "دسته‌بندی یافت نشد" دریافت کردید:
1. بررسی کنید که جدول `categories` در دیتابیس وجود دارد
2. مطمئن شوید که دسته‌بندی‌ها در دیتابیس ثبت شده‌اند
3. بررسی کنید که slug دسته‌بندی‌ها درست است

### اگر خطای آپلود تصویر دریافت کردید:
1. بررسی کنید که bucket `pic` در Supabase Storage وجود دارد
2. مطمئن شوید که RLS policies درست تنظیم شده‌اند
3. بررسی کنید که API keys درست هستند

### اگر خطای "خطا در ثبت آگهی" دریافت کردید:
1. بررسی کنید که جدول `ads` در دیتابیس وجود دارد
2. مطمئن شوید که RLS policies درست تنظیم شده‌اند
3. بررسی console برای جزئیات خطا

## پس از حل مشکل

پس از اعمال این تغییرات:
- ✅ ثبت آگهی بدون خطا کار خواهد کرد
- ✅ تصاویر به درستی آپلود می‌شوند
- ✅ دسته‌بندی‌ها از دیتابیس خوانده می‌شوند
- ✅ مدیریت خطا بهبود یافته است
- ✅ UX بهتر با loading states و notifications 